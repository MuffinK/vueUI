<!DOCTYPE html> <meta charset="utf-8" />
<link rel="stylesheet" href="style.css" type="text/css" media="all" />

<body>
  <div><svg id="netgraph" width="100%" height="100%">
    <defs>
      <marker id="arror" orient='auto' markerWidth="8" markerHeight="8" refX="4" refY="4">
        <path d="M689.621 512l-328.832-328.832-60.331 60.331 268.501 268.501-268.501 268.501 60.331 60.331z" p-id="1968" fill="black"></path>
      </marker>
    </defs>
  </svg></div>
</body>
<script src="/node_modules/d3/build/d3.min.js"></script>
<script>
  // =============================
  // PRINTING DEVICE DETAILS TABLE
  // =============================

  // ########
  // # MAIN #
  // ########
  var svg = d3.select("svg#netgraph"),
    //width = +svg.attr("width"),
    // height = +svg.attr("height");
    width =
      window.innerWidth ||
      document.documentElement.clientWidth ||
      document.body.clientWidth,
    height =
      window.innerHeight ||
      document.documentElement.clientHeight ||
      document.body.clientHeight;

  d3.select("svg").attr("height", height);
  d3.select("svg").attr("width", width );

  var color = d3.scaleOrdinal(d3.schemeCategory20);

  var simulation = d3
    .forceSimulation()
    .force(
      "link",
      d3
        .forceLink()
        .id(d => d.id)
        .distance(100)
        .strength(1)
    )
    .force(
      "charge",
      d3
        .forceManyBody()
        .strength(-200)
        .distanceMax(500)
        .distanceMin(50)
    )
    // .force("x", d3.forceX(d => (d.group * width) / 7).strength(1))
    // .force("y", d3.forceY(d => d.yPlace * height / 15).strength(1))
    .force("center", d3.forceCenter(width / 2, height / 2))
    .force("collision", d3.forceCollide().radius(35));

  // ######################################
  // # Read graph.json and draw SVG graph #
  // ######################################
  d3.json("python/graph.json", function(error, graph) {
    if (error) throw error;

    var link = svg
      .append("g")
      .selectAll("line")
      .data(graph.links)
      .enter()
      .append("line")
      .attr("stroke", function(d) {
        return color(parseInt(d.value));
      })
      .attr("stroke-width", function(d) {
        return Math.sqrt(parseInt(d.value));
      })
      .attr("class", 'pass')
      .attr("marker-mid", "url(#arror)");

    var node = svg
      .append("g")
      .attr("class", "nodes")
      .selectAll("a")
      .data(graph.nodes)
      .enter()
      .append("a")
      .attr("target", "_blank")
      .attr("xlink:href", d =>
        window.location.href + "?device=" + d.id
      );

    node.on("click", function(d, i) {
      d3.event.preventDefault();
      d3.event.stopPropagation();
      OnClickDetails(d.id);
    });

    node.call(
      d3
        .drag()
        .on("start", dragstarted)
        .on("drag", dragged)
        .on("end", dragended)
    );

    node
      .append("image")
      .attr("xlink:href", d =>
        "img/group" + d.group + ".png"
      )
      .attr("width", 32)
      .attr("height", 32)
      .attr("x", -16)
      .attr("y", -16)
      .attr("fill", d =>
        color(d.group)
      );

    node
      .append("text")
      .attr("font-size", "0.8em")
      .attr("dx", "-3em")
      .attr("dy", "-2em")
      .attr("x", +8)
      .text(function(d) {
        return d.id;
      });

    node.append("title").text(function(d) {
      return d.id;
    });

    simulation.nodes(graph.nodes).on("tick", ticked);

    simulation.force("link").links(graph.links);

    function ticked() {
      link
        .attr("x1", function(d) {
          return d.source.x;
        })
        .attr("y1", function(d) {
          return d.source.y;
        })
        .attr("x2", function(d) {
          return d.target.x;
        })
        .attr("y2", function(d) {
          return d.target.y;
        });

      node.attr("transform", d=>
         "translate(" + d.x + "," + d.y + ")"
      );
    }
  });

  function dragstarted(d) {
    if (!d3.event.active) simulation.alphaTarget(0.3).restart();
    d.fx = d.x;
    d.fy = d.y;
  }

  function dragged(d) {
    d.fx = d3.event.x;
    d.fy = d3.event.y;
  }

  function dragended(d) {
    if (!d3.event.active) simulation.alphaTarget(0);
    d.fx = null;
    d.fy = null;
  }
</script>
